<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>How to Create a Fluent API DSL with Lambda Builders - Code One 2018 - BOF 5129</title>
  <meta name="description" content="dOOv is fluent, stream-like API, great for writing type checked code, taking advantage of Java 8 functions and lambdas. In this presentation we will explore the issues of the predicate reduction features of dOOv.">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="bower_components/reveal.js/css/reveal.css">
  <link rel="stylesheet" href="bower_components/reveal.js/lib/css/zenburn.css">
  <link rel="stylesheet" href="css/ocode-theme.css" id="theme">
  <style>
      body {
        background-color: #034a5e;
        background-image: linear-gradient(to bottom right,#004153,#0d718d, #515d7f, #b23743, #f05829);
        background-image: -webkit-linear-gradient(to bottom right,#004153,#0d718d, #515d7f, #b23743, #f05829);
      }
  </style>
  <script>
    if (window.location.search.match(/print-pdf/gi)) {
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = 'css/print/pdf.css';
      document.getElementsByTagName('head')[0].appendChild(link);
    }
  </script>
</head>

<body>
  <div class="footer">
    <img class="logo-lesfurets" src="img/logo_lesfurets_blanc.png">
    <img class="logo-lesfurets" src="img/doov_io_logo_clear_small.png">
    <img class="logo-conference" src="img/ocode-one-logo.png">
  </div>
  <div class="reveal">
    <div class="slides">

      <section>
        <img class="logo herve-francois" width="45%" src="img/lf_com_herve_francois.png">
        <div class="container-grid-2">
          <h1 class="code">How to Create
            <br>a Fluent API DSL
            <br>with Lambda Builders
            <br>BOF 5129
          </h1>
        </div>
      </section>

      <section>
        <section>
          <h2>Welcome to the Furets!</h2>
        </section>
        <section>
          <div class="">
            <h2>@ozangunalp – Ozan Gunalp</h2>
            <ul>
              <li>PhD in Computer Science, JenkinsPipelineUnit author</li>
              <li>Software Architect at LesFurets.com</li>
            </ul>
          </div>
          <br>
          <br>
          <div class="">
            <h2>@gdigugli – Gilles Di Guglielmo</h2>
            <ul>
              <li>Designer of sweet cooked software since 1999</li>
              <li>Software Architect at LesFurets.com</li>
            </ul>
          </div>
          <br>
          <br>
          <div class="">
            <h2>@geofberard – Geoffrey Berard</h2>
            <ul>
              <li>Software Developer since 2012</li>
              <li>Team Lead, React JS Evangelist</li>
            </ul>
          </div>
        </section>
        <section>
          <img width="50%" src="img/logo_lesfurets.png">
          <p></p>
          <ul class="">
            <li>1 website, 5 Insurance Products : Car, Health, Home, Bike, Loan</li>
            <li class="emptyline">1 codebase, 450k lines of code, 60k unit tests, 150 selenium tests</li>

            <li>20 Developers, 2 DevOps, 4 Architects</li>
            <li class="emptyline">20 production servers including Load balancers, Frontend, Backend, Databases, BI</li>

            <li>1 release per day</li>
            <li class="emptyline">9 years of code history
              <br/>
            </li>

            <li>3M quotes/year, 40% of market share, 4M of customers</li>
          </ul>
        </section>
      </section>

      <section>
        <section>
          <h2>Introduction</h2>
        </section>

        <section data-transition="slide-in fade-out">
          <img width="66%" src="img/lf_car_journey.png">
        </section>

        <section data-transition="fade">
          <img width="66%" src="img/lf_com_car_price_sheet.png">
        </section>

        <section data-transition="fade">
          <h2>LesFurets service orchestration</h2>
          <img width="80%" src="img/lf_scatter_gather.jpg">
        </section>

        <section data-transition="fade-in slide-out">
          <h2>LesFurets service orchestration</h2>
          <img width="80%" src="img/lf_scatter_gather_doov.jpg">
        </section>

        <section>
          <h2>Insurers partners</h2>
          <p>We have 100 live insurers, on 5 products, each with
            <strong>business validation rules</strong>, that filter prospects based on their profile</p>
        </section>

        <section>
          <h2>Insurer exclusions</h2>
          <p>Hierarchy of 492 legacy classes, no governance or auditability</p>
          <img width="40%" src="img/exclusion-list.png">
        </section>

        <section>
          <h2>Use case: insurer exclusions</h2>
          <p>Insurer exclusions based on object model (legacy code)</p>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                <code class="code lang-java">
public void check(FieldContext context, FormuleMoto formule, Conducteur conducteur,
                  Vehicule vehicule, Void unused, Besoins besoins,
                  Set&lt;EAbTestingScenario&gt; scenarios)
                  throws ExclusionException {
    if (besoins == null) {
        return;
    }
    if (besoins.getDateDebutContrat() == null) {
        return;
    }
    if (!DateHelper.isAfter(besoins.getDateDebutContrat(),
                    DateHelper.ajouteJoursADate(DateHelper.getToday(), NBR_JOURS),
                    DateHelper.EPrecision.jour)) {
        throw new ExclusionException(DATE_EFFET_PLUS_60_JOURS);
    }
}
                </code>
              </pre>
          </div>
        </section>

        <section>
          <h2>Use case: goal</h2>
          <ul>
            <li>
              <strong>compliance</strong>: the rules correspond to the specification documents</li>
            <li>
              <strong>auditability</strong>: understand a rule without looking at the code</li>
            <li>
              <strong>governance</strong>: maintenance of the rules catalogue</li>
            <li>
              <strong>clarity</strong>: productivity for developers</li>
          </ul>
          <p>Same rule, more
            <strong>fluent</strong>:</p>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
public ExclusionRule exclusionRule() {
    return DOOV.when(dateContrat().after(todayPlusDays(60)))
               .exclusionRule();
}
                </code>
              </pre>
          </div>
        </section>

        <section>
          <h2>Why a fluent API?</h2>
          <p>Java is verbose, but you can reduce the noise and write code like natural language with a fluent API</p>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
// SQL query with jOOQ
DSL.using(conn)
        .selectFrom(SALES)
        .where(MODULE.equal(module.getIntValue()))
        .and(NOTIF_DATETIME.greaterOrEqual(from))
        .and(DELETED.equal(SaleState.NO.getIntValue()))
        .stream()
        .map(SalesDAO::toSale)
        .collect(toList());
                </code>
              </pre>
          </div>
        </section>

        <section>
          <h2>Meet dOOv!</h2>
          <p>
            <strong>D</strong>omain
            <strong>O</strong>bject
            <strong>O</strong>riented
            <strong>V</strong>alidation</p>
          <img class="logo herve-francois" src="img/doov_io_logo_dark_large.png" width="40%">
          <p>dOOv is a fluent API for typesafe domain model validation</p>
        </section>

        <section>
          <p>
            <strong>dOOv</strong> : Under the hood</p>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
DOOV.when(accountCompany.eq(Company.LES_FURETS)
            .and(accountPhoneNumber.startsWith("+33"))).validate();
                </code>
              </pre>
          </div>
          <br/>
          <img src="img/metadata_lambda_tree.svg" width="90%">
        </section>
      </section>

      <section>
        <section>
          <h2>Live code</h2>
        </section>
        <section>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
public static boolean validateAccount(User user,
                Account account, Configuration config) {
  if (config == null) {
      return false;
  }
  if (user == null || user.getBirthDate() == null) {
      return false;
  }
  if (account == null || account.getCountry() == null ||
      account.getPhoneNumber() == null) {
      return false;
  }
  if (YEARS.between(user.getBirthDate(), LocalDate.now()) >= 18
          && account.getEmail().length() <= config.getMaxEmailSize()
          && account.getCompany() == Company.LES_FURETS
          && account.getPhoneNumber().startsWith("+33")) {
      return true;
  }
  return false;
}
                </code>
              </pre>
          </div>
        </section>

        <section>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
public static SampleModel sample() {
  User user = new User();
  user.setId(1);
  user.setFirstName("Foo");
  user.setLastName("BAR");
  // ...
            
  Account account = new Account();
  account.setCompany(Company.LES_FURETS);
  account.setId(9);
  // ...
                </code>
              </pre>
          </div>
        </section>
        <section>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
public class Account extends Identity {

  @SamplePath(field = SampleFieldId.LOGIN, readable = "account.login")
  private String login;     
  // ...

  <mark>@SamplePath(field = SampleFieldId.COMPANY, readable = "account.company")</mark>
  private Company company;
  // ...
                </code>
              </pre>
          </div>
        </section>
        <section>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-xml output">
SampleModelResourceBundle_en_US.properties

account.login = account login
account.password = account password
account.country = account country
<mark>account.company = account company</mark>
...

SampleModelResourceBundle_fr_FR.properties

account.login = l'identifiant de connection
account.country = le pays
<mark>account.company = la soci\u00e9t\u00e9</mark>
...

                </code>
              </pre>
          </div>
        </section>
        <section>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-xml output">
> ./gradlew -p sample build

BUILD SUCCESSFUL in 23s
10 actionable tasks: 3 executed, 7 up-to-date
                </code>
              </pre>
          </div>
        </section>

        <section>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
public class RulesCodeOneTest {
  SampleModelRule demoRule = DslSampleModel
          .when(DOOV.matchAll(
                  userBirthdate.ageAt(today()).greaterOrEquals(18),
                  accountEmail.length().lesserOrEquals(configurationMaxEmailSize),
                  accountCompany.eq(Company.LES_FURETS),
                  accountPhoneNumber.startsWith("+33")))
          .validate();
}
                </code>
              </pre>
          </div>
        </section>
        <section>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
@Test
public void test_account() {
    SampleModel sample = SampleModels.sample();
              
    Result result = demoRule.executeOn(sample);
              
    Assertions.assertThat(result).isTrue();
    System.out.println(demoRule.readable());
    System.out.println(demoRule.markdown(Locale.FRANCE));
}
                </code>
              </pre>
          </div>
        </section>

        <section>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-xml output">
rule when match all [user birthdate age at today >= 18, //
  account email length is <= configuration max email size, //
  account company = LES_FURETS, account phone number starts with '+33'] validate
* règle
  * lorsque
    * correspond à tous
      * la date de naissance âge à la date du jour >= 18
      * l'émail a une longueur <= la taille maximum de l'émail
      * la société = LES_FURETS
      * le numéro de téléphone commence par '+33'
  * valider
                </code>
              </pre>
          </div>
        </section>

        <section>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
@Test
public void test_account_failure_cause() {
    SampleModel sample = SampleModels.sample();
    <mark>sample.getAccount().setPhoneNumber("+1 12 34 56 78");</mark>
              
    Result result = demoRule.executeOn(sample);
              
    Assertions.assertThat(result).isTrue();
}
                </code>
              </pre>
          </div>
        </section>


        <section>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-xml output">
java.lang.AssertionError: Expected result to be true 
  (invalidated nodes: [account phone number starts with '+33'])
                </code>
              </pre>
          </div>
        </section>

        <section>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
@Test
public void test_account_failure_cause() {
    SampleModel sample = SampleModels.sample();
    sample.getAccount().setPhoneNumber("+1 12 34 56 78");
              
    Result result = demoRule.executeOn(sample);
              
    Assertions.assertThat(result)
            <mark>.isFalse()</mark>
            <mark>.hasFailureCause("account phone number starts with '+33'");</mark>
}
                </code>
              </pre>
          </div>
        </section>

        <section>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
@Test
public void test_account_failure_cause_2() {
    SampleModel sample = SampleModels.sample();
    sample.getAccount().setPhoneNumber("+1 12 34 56 78");
    sample.getAccount().setCompany(Company.BLABLACAR);
              
    <mark>Result result = demoRule.withShortCircuit(false).executeOn(sample);</mark>
              
    Assertions.assertThat(result)
            .isFalse()
            .hasFailureCause("match all [account company = LES_FURETS, " +
                    "account phone number starts with '+33']");
}
                </code>
              </pre>
          </div>
        </section>

      </section>

      <section>
        <section>
          <h2>A few predicate reductions examples</h2>
        </section>
        <section>
          <h2>Multiple 'and' operator</h2>
          <p>
            <em>Validate that a profile
              <br> has an email with less than 20 characters
              <br> has at least 18 years when their country is France
              <br> their country is France when their phone number starts with '+33'</em>
          </p>
          <p/>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-java">
  DOOV.when(accountEmail.length().lesserThan(20)
        .and(userBirthdate.ageAt(today()).greaterThan(18)
          .and(accountCountry.eq(Country.FR)))
        .and(accountCountry.eq(Country.FR)
          .and(accountPhoneNumber.startsWith("+33"))))
      .validate();
                  </code>
                </pre>
          </div>
        </section>

        <section>
          <h2>Multiple 'and' operators</h2>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-java">
  model.getAccount().setEmail("test@test.org");
  model.getAccount().setCountry(Country.FR);
  model.getUser().setBirthDate(LocalDate.now().minusYears(19));
  
  ValidationRule rule = DOOV
      .when(<mark class="true-predicate">accountEmail.length().lesserThan(20)</mark>  
        .and(<mark class="true-predicate">userBirthdate.ageAt(today()).greaterThan(18)</mark>
            .and(<mark class="true-predicate">accountCountry.eq(Country.FR)</mark>))
        .and(<mark class="true-predicate">accountCountry.eq(Country.FR)</mark>
            .and(<mark class="false-predicate">accountPhoneNumber.startsWith("+33")</mark>)))
      .validate();
  
  Result result = rule.withShortCircuit(false).executeOn(wrapper);
  System.out.println("&gt; " + result.getFailureCause());
                  </code>
                </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-xml output">
  &gt; account phone number starts with '+33'
                  </code>
                </pre>
          </div>
        </section>

        <section>
          <h2>'count' operator for predicates</h2>
          <p>
            <em>Validate that a profile match at least two conditions :
              <br>
              <ul>
                <li>profile has at least 18 years</li>
                <li>country is France</li>
                <li>phone number starts with '+33'</li>
              </ul>
            </em>
          </p>
          <p/>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-java">
  DOOV.when(count(
        userBirthdate.ageAt(today()).greaterThan(18),
        accountCountry.eq(Country.FR),
        accountPhoneNumber.startsWith("+33")).greaterThan(1))
      .validate();
                  </code>
                </pre>
          </div>
        </section>

        <section>
          <h2>'count' operator for predicates</h2>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-java">
  model.getUser().setBirthDate(LocalDate.now().minusYears(19));
  model.getAccount().setCountry(Country.CAN);
  model.getAccount().setPhoneNumber("1 23 45 67 89");
  
  ValidationRule rule = DOOV
      .when(count(
              <mark class="true-predicate">userBirthdate.ageAt(today()).greaterThan(18)</mark>,
              <mark class="false-predicate">accountCountry.eq(Country.FR)</mark>,
              <mark class="false-predicate">accountPhoneNumber.startsWith("+33")</mark>)
          .greaterThan(1))
      .validate();
  
  Result result = rule.withShortCircuit(false).executeOn(wrapper);
  System.out.println("&gt; " + result.getFailureCause());
                  </code>
                </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-xml output">
  &gt; account country = FR and account phone number starts with '+33'
                  </code>
            </pre>
          </div>
        </section>

      </section>

      <section>
        <section>
          <h2>Beyond bean validation</h2>
          <p>Annotation based APIs for validating POJOs</p>
          <p>Bean Validation 2.0 : <strong>JSR 380</strong><br>
            Reference implementation : <strong>Hibernate Validator</strong></p>
        </section>

        <section>
          <h2>Beyond Bean Validation: types</h2>
          <p>Bean Validation rules are not strongly typed since it's annotation based. This code will fail at compile time,
            but your IDE won't be able to tell you why.</p>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
public class Account {

    @NotNull @Email
    private Email email;

}
                </code>
              </pre>
          </div>
        </section>

        <section>
          <h2>Beyond Bean Validation: complex validation</h2>
          <p>Because Bean Validation constraints are based on field annotation, cross validation between fields are only available
            through the extension mechanism.</p>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
public class Account {

    @Pattern(regexp = "(FR)|(UK)")
    private String country;

    @Pattern(regexp = "???")
    private String phoneNumber;

}
                </code>
              </pre>
          </div>
        </section>

        <section>
          <h2>Beyond Bean Validation: natural language</h2>
          <p>Bean Validation rules are not written with a natural language syntax and does not provide a syntax tree</p>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
@Size(min = 10, max = 200,
      message = "About Me must be between 10 and 200 characters")
private String aboutMe;
                </code>
              </pre>
          </div>
          <p></p>
          <h2>DSL</h2>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
userAboutMe().length().between(10, 200).validate().readable()
&gt; When user about me length is between 10 and 200, validate
                </code>
              </pre>
          </div>
        </section>

        <section>
          <img src="img/exclusions_maintenance_page.png" width="90%">
        </section>

        <section>
          <img src="img/doov_bench_ui.png" width="90%">
          <p>Visit our blog for details:
            <a href="https://beastie.lesfurets.com/articles/doov-revisits-bean-validation-benchmark">https://beastie.lesfurets.com</a>
          </p>
        </section>

        <section>
          <h2>Beyond Bean Validation: syntax versus consistency</h2>
          <p>&nbsp;</p>
          <div class="horizontal">
            <div class="column column-2">
              <div>
                <strong style="color:#59B2AC">Bean Validation</strong> allows syntax validation</br>&nbsp;</br>&nbsp;
              </div>
              <div>
                <strong style="color:#59B2AC">Bean Validation</strong> rules are written on the model</br>&nbsp;</br>&nbsp;
              </div>
              <div>
                <strong style="color:#59B2AC">Bean Validation</strong> uses reflection
              </div>
            </div>
            <div class="column column-2">
              <div>
                <strong style="color:#ec7f00">dOOv</strong> allows consistency checks</br>&nbsp;</br>&nbsp;
              </div>
              <div>
                <strong style="color:#ec7f00">dOOv</strong> rules are writtent outside of the model, allowing complex checks</br>&nbsp;</br>&nbsp;
              </div>
              <div>
                <strong style="color:#ec7f00">dOOv</strong> uses code generation
              </div>
            </div>
          </div>
        </section>
      </section>

      <section>
        <section>
          <h2>Going further</h2>
        </section>
        <section>
          <h2>Going further : Implementing rules</h2>
          <div class="code-wrapper small">
            <pre class="prettyprint">
              <code class="code lang-java">
enum Company {
    BLABLACAR, CANAL_PLUS, DAILYMOTION,
    LES_FURETS, MEETIC, OODRIVE,
}
              </code>
            </pre>
          </div>
          <p>
            <em>Validate that the company of an account should
              <strong>NOT</strong> be
              <br> Dailymotion or Blablacar</em>
          </p>
          <div class="code-wrapper small">
            <pre class="prettyprint">
              <code class="code lang-java">
DOOV.when(accountCompany.noneMatch(DAILYMOTION, BLABLACAR)).validate();
              </code>
            </pre>
          </div>
        </section>

        <section>
          <h2>Implementing boolean logic</h2>
          <div class="code-wrapper">
            <pre class="prettyprint">
              <code class="code lang-java">
¬ DAILYMOTION ∧ ¬ BLABLACAR
// is equivalent to
¬ ( DAILYMOTION ∨ BLABLACAR )
// is equivalent to
LES_FURETS ∨ CANAL_PLUS ∨ MEETIC ∨ OODRIVE
              </code>
            </pre>
          </div>
          <br>
          <p>De Morgan's laws<br>
          https://en.wikipedia.org/wiki/De_Morgan's_laws<br>
          https://en.wikipedia.org/wiki/Conjunctive_normal_form</p>
        </section>

        <section>
          <p>
            Failure cause with <strong>noneMatch</strong>
          </p>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                <code class="code lang-java">
model.getAccount().setCompany(DAILYMOTION);

ValidationRule rule = DOOV
      .when(<mark class="false-predicate">accountCompany.noneMatch(DAILYMOTION, BLABLACAR)</mark>)
      .validate();
Result result = rule.withShortCircuit(false).executeOn(model);
System.out.println("&gt; " + result.getFailureCause());
                  </code>
                </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-xml output">
  &gt; account company match none  : DAILYMOTION, BLABLACAR
                  </code>
            </pre>
          </div>
        </section>

        <section>
          <p>
            Failure cause with <strong>notEq + and</strong>
          </p>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                <code class="code lang-java">
DOOV.when(<mark class="false-predicate">accountCompany.notEq(DAILYMOTION)</mark>
            .and(<mark class="true-predicate">accountCompany.notEq(BLABLACAR)</mark>)).validate();
            </code>
          </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                    <code class="code lang-xml output">
  &gt; account company != DAILYMOTION
                    </code>
              </pre>
          </div>
          <p>Conjuctive Normal Form (CNF)</p>
        </section>

        <section>
          <p>
            Failure cause with <strong>not + or</strong>
          </p>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-java">
DOOV.when(<mark class="true-predicate">accountCompany.eq(DAILYMOTION)</mark>
          .or(<mark class="false-predicate">accountCompany.eq(BLABLACAR)</mark>).not())
             .validate();
              </code>
            </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                      <code class="code lang-xml output">
    &gt; not (account company = DAILYMOTION or account company = BLABLACAR)
                      </code>
                </pre>
          </div>
        </section>

        <section>
          <p>
            Failure cause with <strong>anyMatch</strong>
          </p>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                    <code class="code lang-java">
DOOV.when(<mark class="false-predicate">accountCompany.anyMatch(LES_FURETS, CANAL_PLUS, MEETIC, OODRIVE)</mark>)
        .validate();
                </code>
              </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                <code class="code lang-xml output">
&gt; account company != DAILYMOTION
                </code>
              </pre>
          </div>
        </section>

        <section>
          <p>
            Failure cause with <strong>eq + or</strong>
          </p>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                      <code class="code lang-java">
DOOV.when(
    <mark class="false-predicate">accountCompany.eq(LES_FURETS)</mark>.or(<mark class="false-predicate">accountCompany.eq(CANAL_PLUS)</mark>
            .or(<mark class="false-predicate">accountCompany.eq(MEETIC)</mark>.or(<mark class="false-predicate">accountCompany.eq(OODRIVE)</mark>))))
                    .validate();
                  </code>
                </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-xml output">
  &gt; account company = LES_FURETS or (account company = CANAL_PLUS 
         or (account company = MEETIC or account company = OODRIVE))
                  </code>
                </pre>
          </div>
        </section>

        <section>
          <h2>Speed is not enough</h2>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                  <code class="code lang-xml output">
Benchmark                                     Mode  Cnt     Score      Error   Units
<mark class="true-predicate"><strong>noneMatch</strong>                                     thrpt   20  8775.818 ± 148.951  ops/ms</mark>
<mark><strong>notEq + and</strong>  [failure cause OK]               thrpt   20  5022.391 ± 147.550  ops/ms</mark>
<strong>not + or</strong>                                      thrpt   20  3022.433 ± 586.881  ops/ms
<strong>anyMatch</strong>     [failure cause OK]               thrpt   20  6002.415 ±  94.531  ops/ms
<mark class="false-predicate"><strong>eq + or</strong>                                       thrpt   20  1855.837 ±  50.183  ops/ms</mark>
                  </code>
                </pre>
          </div>
          <br>
          <div class="code-wrapper small">
            <pre class="prettyprint">
                    <code class="code lang-xml output">
Benchmark                                     Mode  Cnt     Score      Error   Units
<strong>noneMatch</strong>    with short circuit               thrpt   20  6839.429 ± 262.318  ops/ms
<mark class="true-predicate"><strong>notEq + and</strong>  with short circuit               thrpt   20  7397.586 ± 252.090  ops/ms</mark>
<strong>not + or</strong>     with short circuit               thrpt   20  5084.227 ± 450.013  ops/ms
<strong>anyMatch</strong>     with short circuit               thrpt   20  6275.185 ±  56.600  ops/ms
<mark class="false-predicate"><strong>eq + or</strong>      with short circuit               thrpt   20  1820.198 ±  60.300  ops/ms</mark>
                    </code>
                  </pre>
          </div>
          <br>
          <strong>notEq + and (CNF)</strong> is the overall winner<br>
          <strong>anyMatch (on inverse subset)</strong> is the winner only for enumerated values
        </section>

      </section>
      <section>
        <section>
          <h2>Conclusion</h2>
        </section>

        <section>
          <h2>Goal</h2>
          <p>We migrated our 492 business rules to dOOv,
            <br/> we now have
            <strong>compliance</strong>,
            <strong>auditability</strong>,
            <strong>governance</strong>,
            <strong>clarity</strong>
            <br/>(and more!)</p>
        </section>

        <section>
          <h2>dOOv 2.2.0 is out!</h2>
          <ul>
            <li>
              <strong>Gradle</strong> code generation support</li>
            <li>
              <strong>Better</strong> failure causes</li>
            <li>
              <strong>New</strong> operators for some types</li>
            <li>
              <strong>Improved</strong> documentation (javadoc and wiki)</li>
            <li>
              <strong>dOOm</strong> beta support</li>
          </ul>
        </section>

        <section>
          <h2>What is dOOm?</h2>
          <p>Next step is extending the DSL to create an
            <strong>object to object mapping framework</strong>, Domain Object Oriented Mapping (
            <strong>dOOm</strong>). It will feature the same AST to text and statistics functionnalities.</p>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
DOOV.mappings(
  map(userEmail).to(insurerEmail),
  map(userFirstName, userLastName)
      .using(StringJoiner)
      .to(insurerFullName),
  when(userCountry.eq(FR))
    .map(userPhone.to(insurerPhone))
)
                </code>
              </pre>
          </div>
          <p>Stay tuned for the next versions!</p>
        </section>

        <section>
          <h2>Enjoy dOOv.io</h2>
          <img class="logo herve-francois" src="img/doov_io_logo_dark_large.png" width="33%">
          <p>
            <a href="http://www.dOOv.io">http://www.dOOv.io</a>
          </p>
          <ul>
            <li><a href="http://github.com/doov-io/doov">http://github.com/doov-io/doov</a> (framework and examples)</li>
            <li><a href="https://repo1.maven.org/maven2/io/doov">https://repo1.maven.org/maven2/io/doov</a> (maven central: <strong>2.2.0</strong>)</li>
            <li><a href="http://github.com/doov-io/doov-docs">http://github.com/doov-io/doov-docs</a> (slides)</li>
            <li>Apache Licence</li>
            <li>Try and contribute!</li>
          </ul>
        </section>

      </section>

      </section>

      <section>
        <section>
          <h2>Appendices</h2>
        </section>

        <section>
          <h2>DSL</h2>
          <p>
            <em>"A domain-specific language (DSL) is a computer language specialized to a particular application domain. This
              is in contrast to a general-purpose language (GPL), which is broadly applicable across domains"</em>
          </p>
        </section>

        <section>
          <h2>dOOv ecosystem</h2>
          <img class="logo herve-francois" src="img/doov_ecosystem.svg" width="75%">
        </section>

        <section>
          <h2>How to write a validation rule?</h2>
          <div class="horizontal">
            <div class="column">
              <p>
                <strong>key model</strong>
              </p>
              <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-java">
// Root class of model
class Model {
  User user;
}

// Add key named EMAIL
enum ModelFieldId {
  <mark class="fragment">EMAIL</mark>;
}

// Annotate email field
class User {
  @Path(field = <mark class="fragment">EMAIL</mark>
        readable = <mark class="fragment true-predicate">...</mark>)
  String email;
}
                    </code>
                  </pre>
              </div>
            </div>
            <div class="column fragment">
              <p>
                <strong>code generate</strong>
              </p>
              <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-java">
// dOOv typed field class
class DslModel {
  StringFieldInfo <mark class="fragment true-predicate">userEmail</mark>;
}
                    </code>
                  </pre>
              </div>
            </div>
            <div class="column fragment">
              <p>
                <strong>write rules</strong>
              </p>
              <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-java">
// Create rules by using
// generated fields
// in DslModel
DslModel
  .when(<mark class="fragment true-predicate">userEmail</mark>.eq(...))
  .validate()
  // Optionaly add rules
  // to a registry
  .registerOn(DEFAULT);
                    </code>
                  </pre>
              </div>
            </div>
          </div>
        </section>

        <section>
          <h2>How to validate a model</h2>
          <div class="horizontal">
            <div class="column">
              <p>
                <strong>get model</strong>
              </p>
              <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-java">
// Get model from somewhere
// or instanciate it
User user = new User();
user.setEmail("e@mail.com");

Model <mark class="fragment">model</mark> = new Model();
model.setUser(user);
                    </code>
                  </pre>
              </div>
            </div>
            <div class="column fragment">
              <p>
                <strong>execute</strong>
              </p>
              <div class="code-wrapper small">
                <pre class="prettyprint">
                    <code class="code lang-java">
// Use executeOn method
DslModel.when(email.matches(...))
        .validate()
        .executeOn(<mark class="fragment">model</mark>);

// Or use the registry
DEFAULT.stream()
  .map(rule -&gt; rule.executeOn(<mark class="fragment">model</mark>));
                    </code>
                  </pre>
              </div>
            </div>
          </div>
        </section>

        <section>
          <h2>Why a fluent API?</h2>
          <p>Java is verbose, but you can reduce the noise and write code like natural language with a fluent API</p>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
// JUnit API
assertEquals(9, fellowshipOfTheRing.size());
assertTrue(fellowshipOfTheRing.contains(frodo, sam));
assertFalse(fellowshipOfTheRing.contains(sauron));

// AssertJ API (fluent)
assertThat(fellowshipOfTheRing).hasSize(9)
                               .contains(frodo, sam)
                               .doesNotContain(sauron);
                </code>
              </pre>
          </div>
        </section>

        <section>
          <h2>Fluent API</h2>
          <p>New elements in Java 8 makes it easier to write a fluent API</p>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
// java.util.function (io.doov.core.dsl.impl.LogicalBinaryCondition)
left.predicate().and(right.predicate()).test(model, context)

// java.util.stream (io.doov.core.dsl.impl.LogicalNaryCondition)
steps.stream().anyMatch(s -&gt; s.predicate().test(model, context))

// lambda and method reference (io.doov.core.dsl.impl.NumericCondition)
predicate(greaterThanMetadata(field, value),
          (model, context) -&gt; Optional.ofNullable(value),
          (l, r) -&gt; greaterThanFunction().apply(l, r));
                </code>
              </pre>
          </div>
        </section>

        <section>
          <h2>Fluent API</h2>
          <p>Many popular libraries propose fluent APIs like
            <br>
            <strong>jOOQ</strong>,
            <strong>AssertJ</strong>,
            <strong>Apache Spark</strong>, etc.</p>
          <div class="code-wrapper">
            <pre class="prettyprint">
                <code class="code lang-java">
Dataset&lt;Row&gt; averagePrice = prices
        .filter(value.&lt;String&gt;getAs("insurer")
                     .equals("COOL insurer"))
        .groupBy("product")
        .agg(avg("price").as("average"))
        .orderBy(desc("average"));
                </code>
              </pre>
          </div>
        </section>

        <section>
          <h2>Syntax tree</h2>
          <img src="dot/ast.svg" width="35%">
        </section>
  
        <section>
          <h2>Why a syntax tree?</h2>
          <p>Makes readable text generation possible:
          <br/>we can output a multi-language rules catalog
          <br/>in multiple formats (text, markdown, HTML, etc.)</p>
          <img src="img/doov_rules_visitor_test.png" width="90%">
        </section>
  
        <section>
          <h2>Execution statistics</h2>
          <p>We make daily statistics that helps us shape the business,
          <br/>by removing or tweaking rules as needed</p>
          <img src="img/doov_failure_cause.png" width="90%">
        </section>

        <section>
            <h2>Combined 'and' & 'or' operators</h2>
            <p>
              <em>Validate that a profile
                <br> has at least 18 years when their country is France
                <br> and their phone number starts with '+33'
                <br> has at least 21 years when their country is Canadian
                <br> and their phone number starts with '+1'</em>
            </p>
            <p/>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                      <code class="code lang-java">
    DOOV.when(userBirthdate.ageAt(today()).greaterThan(18)
            .and(accountCountry.eq(Country.FR)
            .and(accountPhoneNumber.startsWith("+33")))
            .or(userBirthdate.ageAt(today()).greaterThan(21)
                  .and(accountCountry.eq(Country.CAN)
                  .and(accountPhoneNumber.startsWith("+1")))))
        .validate();
                      </code>
                    </pre>
            </div>
          </section>
  
          <section>
            <h2>Combined 'and' & 'or' operators</h2>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-java">
    model.getUser().setBirthDate(LocalDate.now().minusYears(22));
    model.getAccount().setCountry(Country.FR);
    
    ValidationRule rule = DOOV
        .when(<mark class="true-predicate">userBirthdate.ageAt(today()).greaterThan(18)</mark>
            .and(<mark class="true-predicate">accountCountry.eq(Country.FR)</mark>
            .and(<mark class="false-predicate">accountPhoneNumber.startsWith("+33")</mark>))
            .or(<mark class="true-predicate">userBirthdate.ageAt(today()).greaterThan(21)</mark>
                  .and(<mark class="false-predicate">accountCountry.eq(Country.CAN)</mark>
                  .and(<mark class="false-predicate">accountPhoneNumber.startsWith("+1")</mark>))))
        .validate();
    
    Result result = rule.withShortCircuit(false).executeOn(wrapper);
    System.out.println("&gt; " + result.getFailureCause());
                    </code>
                  </pre>
            </div>
            <br>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-xml output">
    &gt; account phone number starts with '+33'
        or (account country = CAN and
            account phone number starts with '+1')
                    </code>
                  </pre>
            </div>
          </section>
          <section>
            <h2>Combined 'matchAll' & 'matchAny' operators</h2>
            <p>
              <em>Validate that a profile
                <br> has at least 18 years when their country is France
                <br> and their phone number starts with '+33'
                <br> has at least 21 years when their country is Canadian
                <br> and their phone number starts with '+1'</em>
            </p>
            <p/>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                      <code class="code lang-java">
    DOOV.when(matchAny(
            matchAll(userBirthdate.ageAt(today()).greaterThan(18),
                     accountCountry.eq(Country.FR),
                     accountPhoneNumber.startsWith("+33")),
            matchAll(userBirthdate.ageAt(today()).greaterThan(21),
                     accountCountry.eq(Country.CAN),
                     accountPhoneNumber.startsWith("+1"))))
         .validate();
                     </code>
                    </pre>
            </div>
          </section>
  
          <section>
            <h2>Combined 'matchAll' & 'matchAny' operators</h2>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-java">
    model.getUser().setBirthDate(LocalDate.now().minusYears(22));
    model.getAccount().setCountry(Country.FR);
    
    ValidationRule rule = DOOV
        .when(matchAny(
            matchAll(<mark class="true-predicate">userBirthdate.ageAt(today()).greaterThan(18)</mark>,
                     <mark class="true-predicate">accountCountry.eq(Country.FR)</mark>,
                     <mark class="false-predicate">accountPhoneNumber.startsWith("+33")</mark>),
            matchAll(<mark class="true-predicate">userBirthdate.ageAt(today()).greaterThan(21)</mark>,
                     <mark class="false-predicate">accountCountry.eq(Country.CAN)</mark>,
                     <mark class="false-predicate">accountPhoneNumber.startsWith("+1")</mark>)))
        .validate();
    
    Result result = rule.withShortCircuit(false).executeOn(wrapper);
    System.out.println("&gt; " + result.getFailureCause());
                    </code>
                  </pre>
            </div>
            <br>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-xml output">
    &gt; match any [account phone number starts with '+33',
                 match all [account country = CAN,
                            account phone number starts with '+1']]
                    </code>
                  </pre>
            </div>
          </section>
  
          <section>
            <h2>'anyMatch' operator for enumerated values</h2>
            <p>
              <em>Validate that a profile country is Canadian or French</em>
            </p>
            <p></p>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-java">
    DOOV.when(accountCountry.anyMatch(Country.CAN, Country.FR)).validate();
                    </code>
                  </pre>
            </div>
          </section>
  
          <section>
            <h2>'anyMatch' operator for enumerated values</h2>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-java">
    model.getAccount().setCountry(Country.UK);
    
    ValidationRule rule = DOOV
        .when(accountCountry.<mark class="false-predicate">anyMatch(Country.CAN, Country.FR)</mark>)
        .validate();
    
    Result result = rule.withShortCircuit(false).executeOn(wrapper);
    System.out.println("&gt; " + result.getFailureCause());
                    </code>
                  </pre>
            </div>
            <br>
            <div class="code-wrapper small">
              <pre class="prettyprint">
                    <code class="code lang-xml output">
    &gt; account country != UK
                    </code>
                  </pre>
            </div>
          </section>

      </section>

    </div>
  </div>
  <script src="bower_components/reveal.js/lib/js/head.min.js"></script>
  <script src="bower_components/reveal.js/js/reveal.js"></script>
  <script>
    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
      controls: false,
      progress: true,
      history: true,
      center: true,
      embedded: true,
      mouseWheel: true,
      viewDistance: 5,

      width: 1280,
      height: 900,
      margin: 0,

      transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none

      // Optional libraries used to extend on reveal.js
      dependencies: [
        { src: 'bower_components/reveal.js/lib/js/classList.js', condition: function () { return !document.body.classList; } },
        { src: 'bower_components/reveal.js/plugin/markdown/marked.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
        { src: 'bower_components/reveal.js/plugin/markdown/markdown.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
        //{ src: 'bower_components/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
        { src: 'bower_components/reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function () { return !!document.body.classList; } },
        { src: 'bower_components/reveal.js/plugin/notes/notes.js', async: true, condition: function () { return !!document.body.classList; } }
      ]
    });

    // navigation with mouse click

    window.addEventListener("mousedown", handleClick, false);
    window.addEventListener("contextmenu", function (e) { e.preventDefault(); }, false);

    function handleClick(e) {
      e.preventDefault();
      if (e.button === 0) Reveal.next();
      if (e.button === 2) Reveal.prev();
    }

  </script>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
  <script src="js/doov.js"></script>
  <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?skin=desert&amp;callback=doov"></script>
</body>

</html>
